<div class="modal-overlay" *ngIf="isOpen" (click)="onOverlayClick($event)">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Demander une étude généalogique</h3>
      <button class="modal-close" (click)="onClose()">&times;</button>
    </div>
    
    <div class="modal-body">
      <div class="study-modal-content">
        <div class="study-intro">
          <p>Décrivez-nous votre projet généalogique et nous vous proposerons une solution personnalisée.</p>
        </div>

        <div class="success-message" *ngIf="submitStatus === 'success'">
          ✅ Votre demande a été envoyée avec succès ! Nous vous répondrons rapidement.
        </div>

        <div class="error-message" *ngIf="submitStatus === 'error'">
          ❌ Une erreur s'est produite lors de l'envoi. Veuillez réessayer.
        </div>

        <form class="study-form" [formGroup]="studyForm" (ngSubmit)="onSubmit()">
          <div class="form-group" [class.error]="email?.invalid && email?.touched">
            <label for="email">Email *</label>
            <input
              type="email"
              id="email"
              formControlName="email"
              placeholder="votre.email@exemple.com"
              (input)="onFieldChange('email')"
            />
            <span class="error-message" *ngIf="email?.invalid && email?.touched">
              L'email est requis et doit être valide
            </span>
          </div>

          <div class="form-row">
            <div class="form-group" [class.error]="name?.invalid && name?.touched">
              <label for="name">Nom complet *</label>
              <input
                type="text"
                id="name"
                formControlName="name"
                placeholder="Votre nom et prénom"
                (input)="onFieldChange('name')"
              />
              <span class="error-message" *ngIf="name?.invalid && name?.touched">
                Le nom est requis
              </span>
            </div>

            <div class="form-group">
              <label for="phone">Téléphone</label>
              <input
                type="tel"
                id="phone"
                formControlName="phone"
                placeholder="06 12 34 56 78"
                (input)="onFieldChange('phone')"
              />
            </div>
          </div>

          <div class="form-group select-group">
            <label for="studyType">Type d'étude</label>
            <select id="studyType" formControlName="studyType" (change)="onFieldChange('studyType')">
              <option value="">Sélectionnez le type d'étude</option>
              <ng-container *ngFor="let group of studyTypeOptions">
                <optgroup [label]="group.label">
                  <option *ngFor="let option of group.options" [value]="option.value">
                    {{ option.label }}
                  </option>
                </optgroup>
              </ng-container>
            </select>
          </div>

          <div class="form-group" [class.error]="message?.invalid && message?.touched">
            <label for="message">Détails de votre demande *</label>
            <textarea
              id="message"
              formControlName="message"
              rows="4"
              placeholder="Décrivez votre projet généalogique : objectifs, informations déjà connues, période recherchée, région géographique..."
              (input)="onFieldChange('message')"
            ></textarea>
            <span class="error-message" *ngIf="message?.invalid && message?.touched">
              Le message est requis
            </span>
          </div>

          <div class="form-info">
            <div class="info-item">
              <span>Confidentialité garantie</span>
            </div>
            <div class="info-item">
              <span>Réponse rapide</span>
            </div>
            <div class="info-item">
              <span>Devis gratuit</span>
            </div>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn-secondary"
              (click)="onClose()"
              [disabled]="isSubmitting"
            >
              Annuler
            </button>
            <button
              type="submit"
              class="btn-primary"
              [class.loading]="isSubmitting"
              [disabled]="isSubmitting || submitStatus === 'success'"
            >
              <span class="loading-spinner" *ngIf="isSubmitting"></span>
              <ng-container *ngIf="isSubmitting">Envoi en cours...</ng-container>
              <ng-container *ngIf="!isSubmitting && submitStatus === 'success'">Envoyé ✅</ng-container>
              <ng-container *ngIf="!isSubmitting && submitStatus !== 'success'">Envoyer la demande</ng-container>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>